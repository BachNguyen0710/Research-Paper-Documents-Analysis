<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BioRxiv Paper Clusters (Euclidean)</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #plot {
            width: 100%;
            height: 90vh;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Visualization of BioRxiv Papers (Euclidean Distance)</h1>
    <div id="plot"></div>

    <script>
        const plotDiv = document.getElementById('plot');

        // Hàm Tải Dữ liệu từ FastAPI
        async function fetchData() {
            try {
                const response = await fetch('/api/data');
                const result = await response.json();

                if (result.error) {
                    plotDiv.innerHTML = `<p style="color: red;">Load data Error: ${result.error}</p>`;
                    return null;
                }
                return result.data;
            } catch (error) {
                plotDiv.innerHTML = `<p style="color: red;"> Can not connect to FastAPI: ${error.message}</p>`;
                return null;
            }
        }

        // Hàm Vẽ Biểu đồ Plotly
        async function renderPlot() {
            const data = await fetchData();
            if (!data) return;

            const uniqueClusters = [...new Set(data.map(d => d.cluster))].sort();

            const plotData = uniqueClusters.map(clusterName => {
                const clusterData = data.filter(d => d.cluster === clusterName);

                const customData = clusterData.map(d => [d.url, d.title, d.doi]);

                const hoverText = clusterData.map(d =>
                    `<b>Title:</b> ${d.title}<br>` +
                    `<b>Cluster:</b> ${d.cluster}<br>` +
                    `<b>DOI:</b> ${d.doi}`
                );

                return {
                    x: clusterData.map(d => d.UMAP_1),
                    y: clusterData.map(d => d.UMAP_2),
                    mode: 'markers',
                    type: 'scattergl',
                    name: clusterName,
                    marker: {
                        size: 8,
                        line: {
                            width: 0.5,
                            color: 'white'
                        }
                    },
                    text: hoverText,
                    hoverinfo: 'text',
                    customdata: customData
                };
            });

            const layout = {
                title: 'Phân cụm Paper bằng UMAP và KMeans (Euclidean)',
                xaxis: { title: 'UMAP 1' },
                yaxis: { title: 'UMAP 2' },
                hovermode: 'closest',
                clickmode: 'event+select'
            };

            Plotly.newPlot(plotDiv, plotData, layout, {
                responsive: true,
                displayModeBar: true
            });

            plotDiv.on('plotly_click', function (eventData) {
                if (eventData.points.length > 0) {
                    const point = eventData.points[0];

                    const url = point.customdata[0];

                    if (url && url.startsWith('http')) {
                        window.open(url, '_blank');
                    } else {
                        console.error("URL is not acceptted or missed:", url);
                        alert("Can not found URL.");
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', renderPlot);
    </script>
</body>

</html>